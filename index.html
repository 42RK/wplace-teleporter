<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wplace Teleporter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Slight grey background for better contrast with panels */
            color: #000000;
        }
        /* Minimalist scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Input Styling */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            background: #000000;
            cursor: pointer;
            margin-top: -6px;
            border-radius: 50%;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #e5e5e5;
        }
        input:focus {
            outline: none;
        }
        .inline-edit {
            background: transparent;
            border: none;
            border-bottom: 1px solid #000;
            outline: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            width: 100%;
            color: inherit;
        }

        /* Compact Top Panel */
        #top-panel {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            z-index: 50;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Fixed Compact Top Panel (approx 25% height dependent on content) -->
    <div id="top-panel" class="w-full flex-none p-4 sm:px-6">
        <div class="max-w-4xl mx-auto w-full space-y-4">
            
            <!-- Header Row -->
            <header class="flex justify-between items-baseline">
                <div class="flex items-baseline gap-3">
                    <h1 class="text-xl font-bold tracking-tight text-black">Teleporter.</h1>
                    <p class="text-gray-400 text-xs hidden sm:inline-block">navigation tool</p>
                </div>
                <div id="coordPreview" class="font-mono text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded">Loading...</div>
            </header>

            <!-- Controls Row 1: Coordinates -->
            <div class="grid grid-cols-4 gap-4">
                <div class="group">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Chunk X</label>
                    <input type="number" id="chunkX" min="0" max="2047" value="0" placeholder="0" class="w-full bg-transparent text-sm font-semibold py-1 border-b border-gray-200 focus:border-black transition-colors placeholder-gray-300 font-mono">
                </div>
                <div class="group">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Chunk Y</label>
                    <input type="number" id="chunkY" min="0" max="2047" value="0" placeholder="0" class="w-full bg-transparent text-sm font-semibold py-1 border-b border-gray-200 focus:border-black transition-colors placeholder-gray-300 font-mono">
                </div>
                <div class="group">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Pixel X</label>
                    <input type="number" id="pixelX" min="0" max="999" value="0" placeholder="0" class="w-full bg-transparent text-sm font-semibold py-1 border-b border-gray-200 focus:border-black transition-colors placeholder-gray-300 font-mono">
                </div>
                <div class="group">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Pixel Y</label>
                    <input type="number" id="pixelY" min="0" max="999" value="0" placeholder="0" class="w-full bg-transparent text-sm font-semibold py-1 border-b border-gray-200 focus:border-black transition-colors placeholder-gray-300 font-mono">
                </div>
            </div>

            <!-- Controls Row 2: Zoom & Actions -->
            <div class="flex items-end gap-6 pt-1">
                <!-- Zoom (Takes available space) -->
                <div class="flex-1 pb-1">
                    <div class="flex justify-between items-end mb-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Zoom</label>
                        <span id="zoomValue" class="text-[10px] font-mono text-black">15.73</span>
                    </div>
                    <input type="range" id="zoomSlider" min="11" max="17" step="0.01" value="15.73" class="block">
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 w-1/2 max-w-[240px]">
                    <button id="copyBtn" class="px-3 py-2 border border-gray-200 rounded text-gray-500 hover:border-black hover:text-black transition-colors text-[10px] font-bold uppercase tracking-widest h-9">
                        Copy
                    </button>
                    <button id="teleportBtn" class="flex-1 bg-black text-white text-[10px] font-bold py-2 rounded hover:bg-gray-800 transition-colors uppercase tracking-widest h-9 shadow-sm">
                        Teleport
                    </button>
                </div>
            </div>
            
            <input type="text" id="rawUrl" readonly class="sr-only">
        </div>
    </div>

    <!-- Scrollable Content Area (Fills remaining space) -->
    <main class="flex-1 overflow-y-auto w-full bg-white">
        <div class="max-w-4xl mx-auto w-full px-4 sm:px-6 py-8">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 h-full">
                <!-- History Column -->
                <div class="flex flex-col">
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-4 sticky top-0 bg-white z-10 pt-2">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-black">History</h2>
                        <button id="clearHistoryBtn" class="text-[10px] font-bold uppercase tracking-widest text-gray-400 hover:text-red-500 transition-colors">Clear</button>
                    </div>
                    
                    <div id="historyList" class="space-y-3"></div>
                    <div id="emptyHistory" class="text-center py-10 hidden">
                        <p class="text-gray-300 text-sm font-light">No teleport history.</p>
                    </div>
                </div>

                <!-- Favorites Column -->
                <div class="flex flex-col h-full">
                    <div class="border-b border-gray-100 pb-2 mb-4 sticky top-0 bg-white z-10 pt-2">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-black">Favorites</h2>
                    </div>

                    <div class="flex items-center space-x-2 w-full mb-4">
                        <input type="text" id="importUrlInput" placeholder="Paste wplace link..." class="flex-1 bg-transparent text-xs py-1.5 border-b border-gray-200 focus:border-black outline-none transition-colors duration-300 placeholder-gray-300">
                        <button id="importUrlBtn" class="px-3 py-1.5 border border-gray-200 rounded-sm text-[10px] font-bold uppercase tracking-widest text-gray-400 hover:border-black hover:text-black transition-colors whitespace-nowrap">Save</button>
                    </div>

                    <div id="favoritesList" class="space-y-3 flex-grow"></div>
                    
                    <div id="emptyFavorites" class="text-center py-10 hidden">
                        <p class="text-gray-300 text-sm font-light">Paste wplace link or star a history item</p>
                    </div>

                    <div class="pt-8 mt-8 flex justify-end space-x-4 border-t border-gray-50">
                        <button id="exportBtn" class="text-[10px] font-bold uppercase tracking-widest text-gray-300 hover:text-black transition-colors">Export JSON</button>
                        <button id="importJsonBtn" class="text-[10px] font-bold uppercase tracking-widest text-gray-300 hover:text-black transition-colors">Import JSON</button>
                        <input type="file" id="jsonFileInput" accept=".json" class="hidden">
                    </div>
                </div>
            </div>

            <div class="w-full text-center pt-12 pb-4">
                 <a href="https://42rk.github.io/" target="_blank" class="text-[10px] font-medium text-gray-300 hover:text-black transition-colors no-underline tracking-widest uppercase">
                    more at 42rk.github.io
                </a>
            </div>
        </div>
    </main>

    <!-- Minimal Toast -->
    <div id="toast" class="fixed top-0 left-0 w-full bg-black text-white text-xs font-medium py-3 text-center transform -translate-y-full transition-transform duration-300 z-50 tracking-widest">
        COPIED TO CLIPBOARD
    </div>

    <!-- Logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script>
        // --- CONSTANTS & MATH ---
        const N_TILES_X = 2048, N_TILES_Y = 2048;
        const N_TILE_PIXELS_X = 1000, N_TILE_PIXELS_Y = 1000;
        const N_PIXELS_X = N_TILES_X * N_TILE_PIXELS_X;
        const N_PIXELS_Y = N_TILES_Y * N_TILE_PIXELS_Y;
        const LON_WEST = -180.0, LON_EAST = 180.0;
        const LAT_NORTH = 85.05113, LAT_SOUTH = -85.05113;
        const WPLACE_URL = "https://wplace.live";

        proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
        proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs");

        const FROM_LONLAT_TRAFO = proj4("EPSG:4326", "EPSG:3857");
        const TO_LONLAT_TRAFO = proj4("EPSG:3857", "EPSG:4326");
        const [WEST, NORTH] = FROM_LONLAT_TRAFO.forward([LON_WEST, LAT_NORTH]);
        const [EAST, SOUTH] = FROM_LONLAT_TRAFO.forward([LON_EAST, LAT_SOUTH]);
        
        const PIXEL_WIDTH = (EAST - WEST) / N_PIXELS_X;
        const PIXEL_HEIGHT = (SOUTH - NORTH) / N_PIXELS_Y;
        const affine_a = PIXEL_WIDTH, affine_b = 0, affine_c = WEST;
        const affine_d = 0, affine_e = PIXEL_HEIGHT, affine_f = NORTH;

        // --- DOM ELEMENTS ---
        const inputs = {
            cx: document.getElementById("chunkX"),
            cy: document.getElementById("chunkY"),
            px: document.getElementById("pixelX"),
            py: document.getElementById("pixelY"),
            zoom: document.getElementById("zoomSlider")
        };
        const els = {
            zoomValue: document.getElementById("zoomValue"),
            coordPreview: document.getElementById("coordPreview"),
            rawUrl: document.getElementById("rawUrl"),
            teleportBtn: document.getElementById("teleportBtn"),
            copyBtn: document.getElementById("copyBtn"),
            importInput: document.getElementById("importUrlInput"),
            importBtn: document.getElementById("importUrlBtn"),
            toast: document.getElementById("toast"),
            
            historyList: document.getElementById("historyList"),
            favoritesList: document.getElementById("favoritesList"),
            emptyHistory: document.getElementById("emptyHistory"),
            emptyFavorites: document.getElementById("emptyFavorites"),
            clearHistoryBtn: document.getElementById("clearHistoryBtn"),

            exportBtn: document.getElementById("exportBtn"),
            importJsonBtn: document.getElementById("importJsonBtn"),
            jsonFileInput: document.getElementById("jsonFileInput"),
        };

        // --- STATE ---
        let historyLog = [];
        let favoritesLog = [];

        // --- UTILS ---
        
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const today = new Date();
            const isToday = date.getDate() === today.getDate() &&
                            date.getMonth() === today.getMonth() &&
                            date.getFullYear() === today.getFullYear();

            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (isToday) return `Today, ${timeStr}`;
            return `${date.toLocaleDateString([], { month: 'short', day: 'numeric' })}, ${timeStr}`;
        }

        function showToast(msg) {
            els.toast.textContent = msg.toUpperCase();
            els.toast.classList.remove("-translate-y-full");
            setTimeout(() => els.toast.classList.add("-translate-y-full"), 2000);
        }

        function getLinkForState(cx, cy, px, py, zoom) {
             const globalPixelX = cx * N_TILE_PIXELS_X + px + 0.5;
            const globalPixelY = cy * N_TILE_PIXELS_Y + py + 0.5;
            const [lon, lat] = pixelToLonLat(globalPixelX, globalPixelY);
            return `${WPLACE_URL}/?lat=${lat}&lng=${lon}&zoom=${zoom}`;
        }

        function findFavoriteName(cx, cy, px, py) {
            const match = favoritesLog.find(f => 
                f.cx === cx && f.cy === cy && f.px === px && f.py === py
            );
            return match ? match.name : null;
        }

        // --- CORE MATH ---

        function pixelToLonLat(col, row) {
            const x = affine_a * col + affine_b * row + affine_c;
            const y = affine_d * col + affine_e * row + affine_f;
            return TO_LONLAT_TRAFO.forward([x, y]);
        }

        function lonLatToPixel(lon, lat) {
            const [x_meters, y_meters] = FROM_LONLAT_TRAFO.forward([lon, lat]);
            const globalPixelX = (x_meters - affine_c) / affine_a;
            const globalPixelY = (y_meters - affine_f) / affine_e;
            return [globalPixelX, globalPixelY];
        }

        function updateLink() {
            let cx = Math.max(0, Math.min(N_TILES_X - 1, parseInt(inputs.cx.value) || 0));
            let cy = Math.max(0, Math.min(N_TILES_Y - 1, parseInt(inputs.cy.value) || 0));
            let px = Math.max(0, Math.min(N_TILE_PIXELS_X - 1, parseInt(inputs.px.value) || 0));
            let py = Math.max(0, Math.min(N_TILE_PIXELS_Y - 1, parseInt(inputs.py.value) || 0));
            let zoom = parseFloat(inputs.zoom.value);

            const globalPixelX = cx * N_TILE_PIXELS_X + px + 0.5;
            const globalPixelY = cy * N_TILE_PIXELS_Y + py + 0.5;
            const [lon, lat] = pixelToLonLat(globalPixelX, globalPixelY);
            
            const url = `${WPLACE_URL}/?lat=${lat}&lng=${lon}&zoom=${zoom}`;

            els.rawUrl.value = url;
            els.zoomValue.textContent = zoom.toFixed(2);
            els.coordPreview.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            
            return { url, cx, cy, px, py, zoom };
        }

        function restoreState(cx, cy, px, py, zoom) {
            inputs.cx.value = cx;
            inputs.cy.value = cy;
            inputs.px.value = px;
            inputs.py.value = py;
            inputs.zoom.value = zoom;
            updateLink();
        }

        // --- RENDERERS ---

        function createListItem(item, type, index) {
            const div = document.createElement('div');
            div.className = "group relative flex items-center justify-between py-2 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors -mx-2 px-3 rounded-md";
            div.id = `item-${type}-${item.id}`;
            
            const isFav = type === 'favorites';
            
            let displayName;
            if (isFav) {
                displayName = item.name;
            } else {
                const favName = findFavoriteName(item.cx, item.cy, item.px, item.py);
                displayName = favName ? favName : `Chunk ${item.cx}, ${item.cy}`;
            }

            const meta = isFav 
                ? `C:${item.cx},${item.cy} • P:${item.px},${item.py}`
                : `${formatTimestamp(item.timestamp)} • P:${item.px},${item.py}`;

            div.innerHTML = `
                <div class="flex-1 cursor-pointer pr-4" onclick="window.restoreItem('${type}', ${item.id})">
                    <div class="font-medium text-black truncate max-w-[200px] text-sm title-text" id="title-${item.id}">${displayName}</div>
                    <div class="text-[10px] font-mono text-gray-400 mt-0.5">${meta}</div>
                </div>
                
                <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity" id="actions-${item.id}">
                    ${!isFav ? `
                        <button onclick="event.stopPropagation(); window.addToFav(${item.id})" class="text-gray-400 hover:text-yellow-500 p-1" title="Star">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                        </button>
                    ` : `
                        <button onclick="event.stopPropagation(); window.startRename(${item.id})" class="text-gray-400 hover:text-black p-1" title="Rename">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                    `}

                     <!-- GO Button -->
                    <button onclick="event.stopPropagation(); window.goItem('${type}', ${item.id})" class="text-green-500 hover:text-green-700 font-black text-[9px] uppercase px-1.5 py-0.5 hover:bg-green-50 rounded border border-transparent hover:border-green-100" title="Open Link">
                        GO
                    </button>

                    <!-- Delete Button (Inline Toggle) -->
                    <button onclick="event.stopPropagation(); window.toggleDelete(this, '${type}', ${item.id})" 
                            class="delete-btn text-gray-300 hover:text-red-500 p-1 transition-colors duration-200" 
                            title="Delete">
                        &times;
                    </button>
                </div>
            `;
            return div;
        }

        function render() {
            // Render History
            els.historyList.innerHTML = '';
            if (historyLog.length === 0) {
                els.emptyHistory.classList.remove('hidden');
            } else {
                els.emptyHistory.classList.add('hidden');
                historyLog.forEach((item, idx) => els.historyList.appendChild(createListItem(item, 'history', idx)));
            }

            // Render Favorites
            els.favoritesList.innerHTML = '';
            if (favoritesLog.length === 0) {
                els.emptyFavorites.classList.remove('hidden');
            } else {
                els.emptyFavorites.classList.add('hidden');
                favoritesLog.forEach((item, idx) => els.favoritesList.appendChild(createListItem(item, 'favorites', idx)));
            }

            localStorage.setItem('wplace_history', JSON.stringify(historyLog));
            localStorage.setItem('wplace_favorites', JSON.stringify(favoritesLog));
        }

        // --- ACTIONS ---

        window.restoreItem = (type, id) => {
            const source = type === 'history' ? historyLog : favoritesLog;
            const item = source.find(i => i.id === id);
            if (item) restoreState(item.cx, item.cy, item.px, item.py, item.zoom);
        }

        window.goItem = (type, id) => {
             const source = type === 'history' ? historyLog : favoritesLog;
            const item = source.find(i => i.id === id);
            if (item) {
                const url = getLinkForState(item.cx, item.cy, item.px, item.py, item.zoom);
                restoreState(item.cx, item.cy, item.px, item.py, item.zoom);
                window.open(url, '_blank');
            }
        }

        window.toggleDelete = (btn, type, id) => {
            if (btn.dataset.confirming === "true") {
                deleteItem(type, id);
                return;
            }
            btn.dataset.confirming = "true";
            btn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            btn.classList.remove("text-gray-300", "hover:text-red-500");
            btn.classList.add("text-red-600", "bg-red-50", "rounded");
            
            setTimeout(() => {
                if (btn && document.body.contains(btn)) {
                    btn.dataset.confirming = "false";
                    btn.innerHTML = "&times;";
                    btn.classList.add("text-gray-300", "hover:text-red-500");
                    btn.classList.remove("text-red-600", "bg-red-50", "rounded");
                }
            }, 3000);
        };

        function deleteItem(type, id) {
            if (type === 'history') {
                historyLog = historyLog.filter(i => i.id !== id);
            } else {
                favoritesLog = favoritesLog.filter(i => i.id !== id);
            }
            render();
        }

        window.startRename = (id) => {
            const titleEl = document.getElementById(`title-${id}`);
            const currentName = titleEl.innerText;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'inline-edit font-medium text-black';
            input.onblur = () => finishRename(id, input.value, currentName);
            input.onkeydown = (e) => {
                if (e.key === 'Enter') input.blur();
                else if (e.key === 'Escape') { input.value = currentName; finishRename(id, currentName, currentName); }
                e.stopPropagation();
            };
            titleEl.innerHTML = '';
            titleEl.appendChild(input);
            input.focus();
            input.select();
        };

        function finishRename(id, newName, oldName) {
            const fav = favoritesLog.find(f => f.id === id);
            if (!fav) return;
            fav.name = newName.trim() || oldName;
            render(); 
            saveFavorites();
        }

        window.addToFav = (id) => {
            const item = historyLog.find(i => i.id === id);
            if (!item) return;
            if (favoritesLog.some(f => f.cx === item.cx && f.cy === item.cy && f.px === item.px && f.py === item.py)) {
                showToast("Already in favorites");
                return;
            }
            const newId = Date.now();
            favoritesLog.unshift({ ...item, id: newId, name: `Chunk ${item.cx}, ${item.cy}` });
            saveFavorites();
            render();
            showToast("Added to Favorites");
            setTimeout(() => window.startRename(newId), 50);
        }

        function saveFavorites() {
            localStorage.setItem('wplace_favorites', JSON.stringify(favoritesLog));
        }

        function exportFavorites() {
            if (favoritesLog.length === 0) { showToast("No favorites"); return; }
            const dataStr = JSON.stringify(favoritesLog, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'wplace_favorites.json');
            linkElement.click();
        }

        function importFavorites(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("Invalid format");
                    let addedCount = 0;
                    importedData.forEach(item => {
                        if(typeof item.cx === 'undefined') return;
                        const exists = favoritesLog.some(f => f.cx === item.cx && f.cy === item.cy && f.px === item.px && f.py === item.py);
                        if (!exists) {
                            favoritesLog.unshift({ ...item, id: Date.now() + Math.random(), timestamp: item.timestamp || new Date().toISOString() });
                            addedCount++;
                        }
                    });
                    if (addedCount > 0) { saveFavorites(); render(); showToast(`Imported ${addedCount}`); } 
                    else { showToast("No new locations"); }
                } catch(err) { showToast("Error reading file"); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function init() {
            try {
                const h = localStorage.getItem('wplace_history');
                const f = localStorage.getItem('wplace_favorites');
                if (h) historyLog = JSON.parse(h);
                if (f) favoritesLog = JSON.parse(f);
            } catch (e) { console.error(e); }

            Object.values(inputs).forEach(el => el.addEventListener('input', updateLink));

            els.teleportBtn.addEventListener('click', () => {
                const data = updateLink();
                historyLog.unshift({ id: Date.now(), timestamp: new Date().toISOString(), ...data });
                if (historyLog.length > 50) historyLog.pop();
                render();
                window.open(data.url, '_blank');
            });

            els.copyBtn.addEventListener('click', () => {
                els.rawUrl.select();
                document.execCommand('copy');
                showToast("Link Copied");
            });

            els.clearHistoryBtn.addEventListener('click', () => {
                const btn = els.clearHistoryBtn;
                if (btn.innerText === "CLEAR") {
                     btn.innerText = "CONFIRM?";
                     btn.classList.add("text-red-500");
                     setTimeout(() => { btn.innerText = "CLEAR"; btn.classList.remove("text-red-500"); }, 3000);
                } else {
                    historyLog = [];
                    render();
                    btn.innerText = "CLEAR";
                    btn.classList.remove("text-red-500");
                }
            });

            els.importBtn.addEventListener('click', () => {
                const val = els.importInput.value.trim();
                if(!val) return;
                try {
                    const url = new URL(val);
                    const params = new URLSearchParams(url.search);
                    const lat = parseFloat(params.get("lat"));
                    const lng = parseFloat(params.get("lng"));
                    const zoom = parseFloat(params.get("zoom")) || 15.73;
                    if(isNaN(lat) || isNaN(lng)) throw new Error();
                    const [gPx, gPy] = lonLatToPixel(lng, lat);
                    const cx = Math.floor(gPx / N_TILE_PIXELS_X);
                    const cy = Math.floor(gPy / N_TILE_PIXELS_Y);
                    if(cx < 0 || cx >= N_TILES_X || cy < 0 || cy >= N_TILES_Y) { showToast("Out of bounds"); return; }
                    const px = Math.floor(gPx % N_TILE_PIXELS_X);
                    const py = Math.floor(gPy % N_TILE_PIXELS_Y);
                    const newId = Date.now();
                    favoritesLog.unshift({ id: newId, name: `Imported ${cx}/${cy}`, cx, cy, px, py, zoom });
                    render();
                    els.importInput.value = '';
                    showToast("Location Saved");
                    setTimeout(() => window.startRename(newId), 50);
                } catch(e) { showToast("Invalid URL"); }
            });

            els.exportBtn.addEventListener('click', exportFavorites);
            els.importJsonBtn.addEventListener('click', () => els.jsonFileInput.click());
            els.jsonFileInput.addEventListener('change', importFavorites);

            updateLink();
            render();
        }

        init();
    </script>
</body>
</html>
